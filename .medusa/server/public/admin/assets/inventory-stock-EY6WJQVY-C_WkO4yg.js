import{I as M}from"./chunk-JHATTPS3-DKo14Q46.js";import{D as B}from"./chunk-NOZD6HRU-CL-bbltH.js";import{D as G,c as H,d as L}from"./chunk-GE4APTT2-UCXTBRRS.js";import{b,a1 as O,dV as $,cZ as Q,j as t,r as P,a8 as U,az as Y,t as N,B as R,ab as Z,ac as i}from"./index-nuRy4NPt.js";import{c as z}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as A}from"./chunk-6HTZNHPT-DkoPnsal.js";import{R as d,u as J}from"./chunk-JGQGO74V-DhFWNNdE.js";import"./index.esm-DEW1DSpk.js";import"./chunk-MWVM4TYO-bKUcYSnf.js";import"./_isIndex-BI6gDjko.js";import"./index-FTuA9u0b.js";import"./checkbox-Cdth9DF7.js";import"./prompt-CKgRI8ea.js";var j=H(),W=(n=[])=>{const{t:r}=b();return P.useMemo(()=>[j.column({id:"title",name:"Title",header:"Title",cell:o=>{const s=o.row.original;return t.jsx(L,{context:o,color:"normal",children:t.jsx("span",{title:s.title||void 0,children:s.title||"-"})})},disableHiding:!0}),j.column({id:"sku",name:"SKU",header:"SKU",cell:o=>{const s=o.row.original;return t.jsx(L,{context:o,color:"normal",children:t.jsx("span",{title:s.sku||void 0,children:s.sku||"-"})})},disableHiding:!0}),...n.map(o=>j.column({id:`location_${o.id}`,name:o.name,header:o.name,field:s=>`inventory_items.${s.row.original.id}.locations.${o.id}`,type:"togglable-number",cell:s=>t.jsx(B,{context:s,disabledToggleTooltip:r("inventory.stock.disabledToggleTooltip")})}))],[n,r])},X=i.object({id:i.string().optional(),quantity:i.union([i.number(),i.string()]),checked:i.boolean(),disabledToggle:i.boolean()}),ee=i.record(X),te=i.object({locations:ee}),oe=i.object({inventory_items:i.record(te)}),se=({items:n,locations:r})=>{const{t:o}=b(),{setCloseOnEscape:s,handleSuccess:m}=J(),c=P.useRef(F(n,r));console.log("initialValues",c.current);const l=U({defaultValues:F(n,r),resolver:Z(oe)}),e=W(r),{mutateAsync:y,isPending:p}=Y(),v=l.handleSubmit(async f=>{var x,k,_,S,I,T,q,C,E,w;const u={create:[],update:[],delete:[],force:!0};for(const[h,V]of Object.entries(f.inventory_items))for(const[g,a]of Object.entries(V.locations)){if(a.id)if(((I=(S=(_=(k=(x=c.current)==null?void 0:x.inventory_items)==null?void 0:k[h])==null?void 0:_.locations)==null?void 0:S[g])==null?void 0:I.checked)&&!a.checked)u.delete.push(a.id);else{const D=a.quantity!==""?z(a.quantity):0,K=(w=(E=(C=(q=(T=c.current)==null?void 0:T.inventory_items)==null?void 0:q[h])==null?void 0:C.locations)==null?void 0:E[g])==null?void 0:w.quantity;D!==K&&u.update.push({id:a.id,inventory_item_id:h,location_id:g,stocked_quantity:D})}!a.id&&a.quantity!==""&&u.create.push({inventory_item_id:h,location_id:g,stocked_quantity:z(a.quantity)})}await y(u,{onSuccess:()=>{N.success(o("inventory.stock.successToast")),m()},onError:h=>{N.error(h.message)}})});return t.jsx(d.Form,{form:l,children:t.jsxs(A,{onSubmit:v,className:"flex size-full flex-col",children:[t.jsx(d.Header,{}),t.jsx(d.Body,{className:"size-full flex-1 overflow-y-auto",children:t.jsx(G,{columns:e,data:n,state:l,onEditingChange:f=>{s(!f)}})}),t.jsx(d.Footer,{children:t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(d.Close,{asChild:!0,children:t.jsx(R,{variant:"secondary",size:"small",type:"button",children:o("actions.cancel")})}),t.jsx(R,{type:"submit",size:"small",isLoading:p,children:o("actions.save")})]})})]})})};function F(n,r){return{inventory_items:n.reduce((o,s)=>{const m=r.reduce((c,l)=>{var y;const e=(y=s.location_levels)==null?void 0:y.find(p=>p.location_id===l.id);return c[l.id]={id:e==null?void 0:e.id,quantity:typeof(e==null?void 0:e.stocked_quantity)=="number"?e==null?void 0:e.stocked_quantity:"",checked:!!e,disabledToggle:((e==null?void 0:e.incoming_quantity)||0)>0||((e==null?void 0:e.reserved_quantity)||0)>0},c},{});return o[s.id]={locations:m},o},{})}}var ve=()=>{var u;const{t:n}=b(),[r]=O(),o=((u=r.get(M))==null?void 0:u.split(","))||void 0,{inventory_items:s,isPending:m,isError:c,error:l}=$({id:o}),{stock_locations:e,isPending:y,isError:p,error:v}=Q({limit:9999,fields:"id,name"}),f=!m&&!!s&&!y&&!!e;if(c)throw l;if(p)throw v;return t.jsxs(d,{children:[t.jsx(d.Title,{asChild:!0,children:t.jsx("span",{className:"sr-only",children:n("inventory.stock.title")})}),t.jsx(d.Description,{asChild:!0,children:t.jsx("span",{className:"sr-only",children:n("inventory.stock.description")})}),f&&t.jsx(se,{items:s,locations:e})]})};export{ve as Component};
